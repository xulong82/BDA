---
title: "R Notebook"
output: html_notebook
---

https://rpubs.com/alecri/258589

# data & pkgs
```{r}

pkg <- c("knitr", "kfigr", "tidyverse", "survival", "ggfortify", "survminer", "plotly",
         "gridExtra", "Epi", "KMsurv", "gnm", "cmprsk", "mstate", "flexsurv", "splines",
         "epitools", "eha", "shiny")

sapply(pkg, require, character.only = TRUE)

orca <- read.table("http://www.stats4life.se/data/oralca.txt", header = T)

orca$all <- 1 * (orca$event != "Alive")
table(orca$all)

ggplotly(
  orca %>%
    mutate(
      text = paste("Subject ID = ", id, "<br>", "Time = ", time, "<br>", "Event = ",  
                   event, "<br>", "Age = ", round(age, 2), "<br>", "Stage = ", stage)
    ) %>%
  ggplot(aes(x = id, y = time, text = text)) +
    geom_linerange(aes(ymin = 0, ymax = time)) +
    geom_point(aes(shape = event, color = event), stroke = 1, cex = 2) +
    scale_shape_manual(values = c(1, 3, 4)) +
    labs(y = "Time (years)", x = "Subject ID") + coord_flip() + theme_classic(),
  tooltip = "text"
)

```

# non-parametric estimators

1. Kaplan-Meier estimator: below
2. Nelson-Aalen estimator

```{r}

su_obj <- Surv(orca$time, orca$all)
str(su_obj)

fit_km <- survfit(su_obj ~ 1, data = orca)
str(fit_km)
print(fit_km, print.rmean = TRUE)

dat_km <- fortify(fit_km)
head(dat_km)

ggsurvplot(fit_km, risk.table = TRUE, xlab = "Time (years)", censor = T)

```

# parametric estimators

1. Exponential
2. Weibull
3. Log logistic

```{r}
flexsurvreg(su_obj ~ 1, data = orca, dist = "exponential")
flexsurvreg(su_obj ~ 1, data = orca, dist = "weibull")
```

# Cox PH model & Poisson

```{r}
m1 = coxph(su_obj ~ sex + I((age-65)/10) + stage, data = orca)
summary(m1)

orca2 <- orca %>%
  filter(stage != "unkn") %>%
  mutate(st3 = Relevel(droplevels(stage), list(1:2, 3, 4)))

m2 <- coxph(Surv(time, all) ~ sex + I((age-65)/10) + st3, data = orca2, ties = "breslow")
summary(m2)
round(ci.exp(m2), 4)

cuts <- sort(unique(orca2$time[orca2$all == 1]))
orca_splitted <- survSplit(Surv(time, all) ~ ., data = orca2, cut = cuts, episode = "tgroup")
head(orca_splitted, 15)

mod_poi <- gnm(all ~ sex + I((age-65)/10) + st3, data = orca_splitted, family = poisson, eliminate = factor(time))
summary(mod_poi)

orca_splitted$dur <- with(orca_splitted, time - tstart)
mod_poi2 <- glm(all ~ -1 + sex + I((age-65)/10) + st3, data = orca_splitted, family = poisson, offset = log(dur))
summary(m2)

orca_splitted$dur <- with(orca_splitted, time - tstart)
mod_poi2 <- glm(all ~ -1 + factor(time) + sex + I((age-65)/10) + st3, data = orca_splitted, family = poisson, offset = log(dur))

mod_poi2 <- glm(all ~ -1 + age, data = orca_splitted, family = poisson, offset = log(dur))
mod_cox2 <- coxph(Surv(time, all) ~ age, data = orca2)

```

# baseline hazard

```{r}
attach(orca2)
tab <- data.frame(table(orca2[orca2$all == 1, "time"])) 
y <- as.numeric(levels(tab[, 1]))[tab[, 1]] # ordered distinct event times
d <- tab[, 2] # number of events

H0 <- basehaz(m2, centered=FALSE)
H0 <- H0[H0[, 2] %in% y, ] # only keep rows where events occurred
